

http://lists.nongnu.org/archive/html/qemu-devel/2011-05/msg01810.html


diff -Nur qemu-kvm-0.14.0-old//hw/acpi_piix4.c qemu-kvm-0.14.0/hw/acpi_piix4.c
--- qemu-kvm-0.14.0-old//hw/acpi_piix4.c	2011-06-03 14:36:48.632000417 +0300
+++ qemu-kvm-0.14.0/hw/acpi_piix4.c	2011-06-03 14:42:12.803000448 +0300
@@ -605,11 +605,13 @@
     BusState *bus = opaque;
     DeviceState *qdev, *next;
     PCIDevice *dev;
+    PCIDeviceInfo *info;
     int slot = ffs(val) - 1;
 
     QLIST_FOREACH_SAFE(qdev, &bus->children, sibling, next) {
         dev = DO_UPCAST(PCIDevice, qdev, qdev);
-        if (PCI_SLOT(dev->devfn) == slot) {
+        info = container_of(qdev->info, PCIDeviceInfo, qdev);
+        if (PCI_SLOT(dev->devfn) == slot && !info->no_hotplug) {
             qdev_free(qdev);
         }
     }
