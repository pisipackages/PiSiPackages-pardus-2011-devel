@@ -, +, @@ 
 ChangeLog         |   12 +++++++++++-
 src/pch.c         |   15 ++++++++++++++-
 tests/Makefile.am |    3 ++-
 tests/dot-dot     |   45 +++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 72 insertions(+), 3 deletions(-)
 create mode 100644 tests/dot-dot
Index: patch-2.6.1.81-5b68/ChangeLog
===================================================================
--- patch-2.6.1.81-5b68.orig/ChangeLog
+++ patch-2.6.1.81-5b68/ChangeLog
@@ -1,3 +1,13 @@
+2011-02-01  Jim Meyering  <meyering@redhat.com>
+
+	do not let a malicious patch create files above current directory
+	This addresses CVE-2010-4651, reported by Jakub Wilk.
+	https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2010-4651
+	* src/pch.c (intuit_diff_type): Reject any file name containing a
+	component of "..".
+	* tests/dot-dot: New file.  Test for this.
+	* tests/Makefile.am (TESTS): Add it.
+
 2009-05-05  Andreas Gruenbacher  <agruen@suse.de>
 
 	* bootstrap.conf: Use the gnulib unistd module.
@@ -3475,7 +3485,7 @@ Sun Dec 17 17:29:48 1989  Jim Kingdon  (
 Copyright (C) 1984, 1985, 1986, 1987, 1988 Larry Wall.
 
 Copyright (C) 1989, 1990, 1991, 1992, 1993, 1997, 1998, 1999, 2000, 2001,
-2002, 2009, 2010 Free Software Foundation, Inc.
+2002, 2009, 2010, 2011 Free Software Foundation, Inc.
 
 This file is part of GNU Patch.
 
Index: patch-2.6.1.81-5b68/src/pch.c
===================================================================
--- patch-2.6.1.81-5b68.orig/src/pch.c
+++ patch-2.6.1.81-5b68/src/pch.c
@@ -3,7 +3,7 @@
 /* Copyright (C) 1986, 1987, 1988 Larry Wall
 
    Copyright (C) 1990, 1991, 1992, 1993, 1997, 1998, 1999, 2000, 2001,
-   2002, 2003, 2006, 2009, 2010 Free Software Foundation, Inc.
+   2002, 2003, 2006, 2009, 2010, 2011 Free Software Foundation, Inc.
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -196,11 +196,37 @@ grow_hunkmax (void)
     return false;
 }
 
+/* Return true if NAME contains a ".." component. */
+
+static bool
+file_name_contains_dot_dot (char const *name)
+{
+	size_t len = strlen (name);
+	return (len >= 3
+		&& (strnEQ (name, "../", 3)
+		|| strnEQ (name + len - 3, "/..", 3)
+		|| strstr (name, "/../")));
+}
+
+/* A file name, NAME, is invalid if it is absolute or if it contains a ".."
+   component. */
+
+static bool
+invalid_file_name (char const *name)
+{
+	return (IS_ABSOLUTE_FILE_NAME (name)
+		|| file_name_contains_dot_dot (name));
+}
+
 static bool
 maybe_reverse (char const *name, bool nonexistent, bool is_empty)
 {
   bool looks_reversed = (! is_empty) < p_says_nonexistent[reverse ^ is_empty];
 
+  /* If it's a name that we'll reject, don't bother prompting. */
+  if (invalid_file_name (name))
+      return false;
+
   /* Allow to create and delete empty files when we know that they are empty:
      in the "diff --git" format, we know that from the index header.  */
   if (is_empty
@@ -936,6 +962,8 @@ intuit_diff_type (bool need_header, mode
 	invc = version_controlled[i];
 	instat = st[i];
       }
+    if (inname && invalid_file_name (inname))
+	fatal ("invalid output file name: %s", quotearg (inname));
 
     return retval;
 }
Index: patch-2.6.1.81-5b68/tests/Makefile.am
===================================================================
--- patch-2.6.1.81-5b68.orig/tests/Makefile.am
+++ patch-2.6.1.81-5b68/tests/Makefile.am
@@ -1,5 +1,5 @@
 # Copyright (C) 1989, 1990, 1991, 1992, 1993, 1997, 1998, 1999, 2002,
-# 2003, 2006, 2009, 2010 Free Software Foundation, Inc.
+# 2003, 2006, 2009, 2010, 2011 Free Software Foundation, Inc.
 
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -24,6 +24,7 @@ TESTS = \
 	create-delete \
 	create-directory \
 	crlf-handling \
+	dot-dot \
 	dash-o-append \
 	empty-files \
 	file-modes \
Index: patch-2.6.1.81-5b68/tests/dot-dot
===================================================================
--- /dev/null
+++ patch-2.6.1.81-5b68/tests/dot-dot
@@ -0,0 +1,50 @@
+# Copyright (C) 2011 Free Software Foundation, Inc.
+#
+# Copying and distribution of this file, with or without modification,
+# in any medium, are permitted without royalty provided the copyright
+# notice and this notice are preserved.
+
+# Don't recognize hunks before a filename has been specified/seen
+
+. $srcdir/test-lib.sh
+
+require_cat
+use_local_patch
+use_tmpdir
+
+# ==============================================================
+
+emit_patch()
+{
+cat <<EOF
+--- /dev/null
++++ $1
+@@ -0,0 +1 @@
++x
+EOF
+}
+
+check 'emit_patch /tmp/x | patch -p0; echo status: $?' <<EOF
+$PATCH: **** invalid output file name: /tmp/x
+status: 2
+EOF
+
+check 'emit_patch a/../z | patch -p0; echo status: $?' <<EOF
+$PATCH: **** invalid output file name: a/../z
+status: 2
+EOF
+
+check 'emit_patch a/../z | patch -p1; echo status: $?' <<EOF
+$PATCH: **** invalid output file name: ../z
+status: 2
+EOF
+
+check 'emit_patch a/.. | patch -p0; echo status: $?' <<EOF
+$PATCH: **** invalid output file name: a/..
+status: 2
+EOF
+
+check 'emit_patch ../z | patch -p0; echo status: $?' <<EOF
+$PATCH: **** invalid output file name: ../z
+status: 2
+EOF
