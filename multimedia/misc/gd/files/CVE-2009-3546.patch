diff -Naur gd-2.0.35.orig/gd_gd.c gd-2.0.35/gd_gd.c
--- gd-2.0.35.orig/gd_gd.c	2009-10-21 20:19:23.000000000 +0300
+++ gd-2.0.35/gd_gd.c	2009-10-21 20:20:15.000000000 +0300
@@ -44,6 +44,10 @@
 	    {
 	      goto fail1;
 	    }
+      if (im->colorsTotal > gdMaxColors)
+      {
+          goto fail1;
+      }
 	}
       /* Int to accommodate truecolor single-color transparency */
       if (!gdGetInt (&im->transparent, in))
